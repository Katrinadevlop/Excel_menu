#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ A –∏ E –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
"""

import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ PATH
sys.path.insert(0, str(Path(__file__).parent))

from app.services.comparator import (
    _extract_dishes_from_both_columns,
    _find_category_ranges,
    normalize_dish,
    col_to_index0
)


def test_extract_dishes_from_both_columns():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–ª—é–¥ –∏–∑ —Å—Ç–æ–ª–±—Ü–æ–≤ A –∏ E –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"""
    print("=== –¢–µ—Å—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –±–ª—é–¥ –∏–∑ —Å—Ç–æ–ª–±—Ü–æ–≤ A –∏ E ===")
    
    # –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - –∏–º–∏—Ç–∞—Ü–∏—è Excel –ª–∏—Å—Ç–∞
    test_values = [
        # row 1: –∑–∞–≥–æ–ª–æ–≤–∫–∏
        ["–ó–ê–í–¢–†–ê–ö–ò", "B", "C", "D", "–ü–ï–†–í–´–ï –ë–õ–Æ–î–ê"],
        # row 2-4: –±–ª—é–¥–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ó–ê–í–¢–†–ê–ö–ò" 
        ["–ö–∞—à–∞ –≥—Ä–µ—á–Ω–µ–≤–∞—è", None, None, None, "–°—É–ø –≥–æ—Ä–æ—Ö–æ–≤—ã–π"],
        ["–û–º–ª–µ—Ç", None, None, None, "–ë–æ—Ä—â —É–∫—Ä–∞–∏–Ω—Å–∫–∏–π"],
        ["–ë–ª–∏–Ω—ã", None, None, None, "–°–æ–ª—è–Ω–∫–∞ –º—è—Å–Ω–∞—è"],
        # row 5: —Å–ª–µ–¥—É—é—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        ["–°–ê–õ–ê–¢–´", "B", "C", "D", "–ú–Ø–°–ù–´–ï –ë–õ–Æ–î–ê"],
        ["–°–∞–ª–∞—Ç –æ–≤–æ—â–Ω–æ–π", None, None, None, "–ö–æ—Ç–ª–µ—Ç—ã –≥–æ–≤—è–∂—å–∏"],
    ]
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–ó–ê–í–¢–†–ê–ö–ò" (—Å—Ç—Ä–æ–∫–∏ 2-4)
    start_row, end_row = 2, 4  # 1-–±–∞–∑–∏—Å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
    dishes = _extract_dishes_from_both_columns(test_values, start_row, end_row, ignore_case=True)
    
    expected_dishes = {
        "–∫–∞—à–∞ –≥—Ä–µ—á–Ω–µ–≤–∞—è", "–æ–º–ª–µ—Ç", "–±–ª–∏–Ω—ã",  # —Å—Ç–æ–ª–±–µ—Ü A
        "—Å—É–ø –≥–æ—Ä–æ—Ö–æ–≤—ã–π", "–±–æ—Ä—â —É–∫—Ä–∞–∏–Ω—Å–∫–∏–π", "—Å–æ–ª—è–Ω–∫–∞ –º—è—Å–Ω–∞—è"  # —Å—Ç–æ–ª–±–µ—Ü E
    }
    
    print(f"–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –±–ª—é–¥–∞: {sorted(dishes)}")
    print(f"–û–∂–∏–¥–∞–µ–º—ã–µ –±–ª—é–¥–∞: {sorted(expected_dishes)}")
    
    assert dishes == expected_dishes, f"–û—à–∏–±–∫–∞! –û–∂–∏–¥–∞–ª–∏ {expected_dishes}, –ø–æ–ª—É—á–∏–ª–∏ {dishes}"
    print("‚úì –¢–µ—Å—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –±–ª—é–¥ –∏–∑ –¥–≤—É—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ")


def test_find_category_ranges():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π"""
    print("\n=== –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ===")
    
    test_values = [
        ["–î–∞—Ç–∞: 05.09.2024", None],
        ["–ó–ê–í–¢–†–ê–ö–ò", None],
        ["–ö–∞—à–∞ –æ–≤—Å—è–Ω–∞—è", "–°—É–ø –≥–æ—Ä–æ—Ö–æ–≤—ã–π"],
        ["–û–º–ª–µ—Ç", "–ë–æ—Ä—â"],
        ["–ü–ï–†–í–´–ï –ë–õ–Æ–î–ê", "–í–¢–û–†–´–ï –ë–õ–Æ–î–ê"],
        ["–°—É–ø –ª–∞–ø—à–∞", "–ö–æ—Ç–ª–µ—Ç—ã"],
        ["–ë–æ—Ä—â –∫—Ä–∞—Å–Ω—ã–π", "–†—ã–±–∞ –∂–∞—Ä–µ–Ω–∞—è"],
    ]
    
    synonyms_map = {
        "–∑–∞–≤—Ç—Ä–∞–∫–∏": "–∑–∞–≤—Ç—Ä–∞–∫–∏",
        "–ø–µ—Ä–≤—ã–µ –±–ª—é–¥–∞": "–ø–µ—Ä–≤—ã–µ –±–ª—é–¥–∞",
    }
    
    ranges = _find_category_ranges(test_values, synonyms_map)
    
    print(f"–ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: {ranges}")
    
    # –û–∂–∏–¥–∞–µ–º: 
    # "–∑–∞–≤—Ç—Ä–∞–∫–∏": —Å—Ç—Ä–æ–∫–∏ 3-4 (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ "–ó–ê–í–¢–†–ê–ö–ò" –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
    # "–ø–µ—Ä–≤—ã–µ –±–ª—é–¥–∞": —Å—Ç—Ä–æ–∫–∏ 6-7 (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ "–ü–ï–†–í–´–ï –ë–õ–Æ–î–ê" –¥–æ –∫–æ–Ω—Ü–∞)
    expected_ranges = {
        "–∑–∞–≤—Ç—Ä–∞–∫–∏": (3, 4),  
        "–ø–µ—Ä–≤—ã–µ –±–ª—é–¥–∞": (6, 7)
    }
    
    assert ranges == expected_ranges, f"–û—à–∏–±–∫–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–∞—Ö! –û–∂–∏–¥–∞–ª–∏ {expected_ranges}, –ø–æ–ª—É—á–∏–ª–∏ {ranges}"
    print("‚úì –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ")


def test_column_indices():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤"""
    print("\n=== –¢–µ—Å—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤ ===")
    
    a_idx = col_to_index0('A')
    e_idx = col_to_index0('E')
    
    print(f"–ò–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ A: {a_idx}")
    print(f"–ò–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ E: {e_idx}")
    
    assert a_idx == 0, f"–°—Ç–æ–ª–±–µ—Ü A –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∏–Ω–¥–µ–∫—Å 0, –ø–æ–ª—É—á–∏–ª–∏ {a_idx}"
    assert e_idx == 4, f"–°—Ç–æ–ª–±–µ—Ü E –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∏–Ω–¥–µ–∫—Å 4, –ø–æ–ª—É—á–∏–ª–∏ {e_idx}"
    
    print("‚úì –¢–µ—Å—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ")


def test_dish_normalization():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞–∑–≤–∞–Ω–∏–π –±–ª—é–¥"""
    print("\n=== –¢–µ—Å—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –±–ª—é–¥ ===")
    
    test_cases = [
        ("–ö–æ—Ç–ª–µ—Ç—ã –≥–æ–≤—è–∂—å–∏ (150–≥)", "–∫–æ—Ç–ª–µ—Ç—ã –≥–æ–≤—è–∂—å–∏"),
        ("–°—É–ø –≥–æ—Ä–æ—Ö–æ–≤—ã–π 250–º–ª", "—Å—É–ø –≥–æ—Ä–æ—Ö–æ–≤—ã–π"),
        ("–ö–∞—à–∞ –≥—Ä–µ—á–Ω–µ–≤–∞—è —Å –º–∞—Å–ª–æ–º, 200–≥", "–∫–∞—à–∞ –≥—Ä–µ—á–Ω–µ–≤–∞—è —Å –º–∞—Å–ª–æ–º"),
        ("", ""),
        (None, "")
    ]
    
    for original, expected in test_cases:
        result = normalize_dish(original, ignore_case=True)
        print(f"'{original}' -> '{result}' (–æ–∂–∏–¥–∞–ª–∏ '{expected}')")
        assert result == expected, f"–û—à–∏–±–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏! '{original}' -> '{result}', –æ–∂–∏–¥–∞–ª–∏ '{expected}'"
    
    print("‚úì –¢–µ—Å—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –±–ª—é–¥ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ")


def main():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    print("–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ A –∏ E")
    print("=" * 60)
    
    try:
        test_column_indices()
        test_dish_normalization()
        test_extract_dishes_from_both_columns()
        test_find_category_ranges()
        
        print("\n" + "=" * 60)
        print("üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!")
        print("–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ A –∏ E —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
        
    except Exception as e:
        print(f"\n‚ùå –¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: {e}")
        import traceback
        traceback.print_exc()
        return False
    
    return True


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
